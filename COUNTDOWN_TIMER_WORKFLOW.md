# å€’è®¡æ—¶å™¨äº¤äº’å·¥ä½œæµç¨‹

> æœ€åæ›´æ–°: 2025-01-XX

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ Real Focus Assistant ä¸­ Pomodoro å€’è®¡æ—¶å™¨çš„å®Œæ•´äº¤äº’å·¥ä½œæµç¨‹ï¼ŒåŒ…æ‹¬ç”¨æˆ·æ“ä½œã€çŠ¶æ€ç®¡ç†ã€UI æ›´æ–°å’Œè‡ªåŠ¨åˆ‡æ¢é€»è¾‘ã€‚

---

## ğŸ¯ æ ¸å¿ƒç»„ä»¶

### 1. çŠ¶æ€ç®¡ç†
- **Pomodoro State** (`pomodoroState`): å­˜å‚¨åœ¨ `popup.js` ä¸­ï¼ŒåŒ…å«ï¼š
  - `session_type`: 'FOCUS' | 'BREAK'
  - `status`: 'RUNNING' | 'PAUSED' | 'IDLE'
  - `start_time`: å¼€å§‹æ—¶é—´æˆ³
  - `target_end_time`: ç›®æ ‡ç»“æŸæ—¶é—´æˆ³
  - `current_cycle`: å½“å‰ç•ªèŒ„é’Ÿå‘¨æœŸ (0-4)

### 2. UI å…ƒç´ 
- **å€’è®¡æ—¶æ–‡æœ¬** (`countdownText`): æ˜¾ç¤º MM:SS æ ¼å¼çš„æ—¶é—´
- **è¿›åº¦æ¡** (`countdownProgressCircle`): SVG åœ†å½¢è¿›åº¦æ¡
- **æ—¶é•¿é€‰æ‹©å™¨** (`durationPicker`): åœæ­¢çŠ¶æ€ä¸‹å¯é€‰æ‹©æ—¶é•¿ (5/15/25/30/45 åˆ†é’Ÿ)
- **çŠ¶æ€æ ‡é¢˜** (`timerStatusTitle`): æ˜¾ç¤º "Focusing" / "Break" / "Paused"
- **æ“ä½œæŒ‰é’®**: Pause / Continue / Stop / Done / Start to Focus

### 3. å®šæ—¶å™¨
- **å€’è®¡æ—¶å®šæ—¶å™¨** (`countdownInterval`): æ¯ 50ms æ›´æ–°ä¸€æ¬¡ï¼ˆ20fpsï¼Œç¡®ä¿åŠ¨ç”»æµç•…ï¼‰
- **ç»Ÿè®¡å®šæ—¶å™¨** (`timerInterval`): æ¯ 1 ç§’æ›´æ–°ä¸€æ¬¡ï¼Œç”¨äºç»Ÿè®¡å’ŒæŒä¹…åŒ–

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### é˜¶æ®µ 1: åˆå§‹åŒ– - å¼€å§‹ä¸“æ³¨

```
ç”¨æˆ·æ“ä½œ: ç‚¹å‡» "Start Focus" æŒ‰é’®
    â†“
1. handleStartFocus() [event-handlers.js]
   â”œâ”€ è·å–å…³é”®è¯å’Œé€‰ä¸­çš„æ—¶é•¿
   â”œâ”€ ä¿å­˜åˆ° Chrome Storage
   â””â”€ å‘é€æ¶ˆæ¯åˆ° Background Script: action: 'init_focus'
    â†“
2. Background Script å¤„ç† [background.js]
   â”œâ”€ åˆ›å»º Pomodoro State
   â”œâ”€ è®¾ç½® start_time å’Œ target_end_time
   â”œâ”€ è®¾ç½® session_type = 'FOCUS'
   â””â”€ è¿”å› pomodoroState
    â†“
3. Popup æ¥æ”¶å“åº” [popup.js]
   â”œâ”€ æ›´æ–°æœ¬åœ° pomodoroState
   â”œâ”€ renderPomodoroState() [ui-manager.js]
   â”‚  â”œâ”€ æ›´æ–°çŠ¶æ€æ ‡é¢˜: "Focusing"
   â”‚  â”œâ”€ æ˜¾ç¤º focusActions (Pause æŒ‰é’®)
   â”‚  â”œâ”€ éšè—å€’è®¡æ—¶æ–‡æœ¬ï¼Œæ˜¾ç¤ºæ—¶é•¿é€‰æ‹©å™¨
   â”‚  â””â”€ æ›´æ–°ç•ªèŒ„é’Ÿå‘¨æœŸæŒ‡ç¤ºå™¨
   â”œâ”€ startCountdown() [popup.js]
   â”‚  â””â”€ å¯åŠ¨å€’è®¡æ—¶å®šæ—¶å™¨ (æ¯ 50ms æ›´æ–°)
   â””â”€ startTimer() [popup.js]
      â””â”€ å¯åŠ¨ç»Ÿè®¡å®šæ—¶å™¨ (æ¯ 1 ç§’æ›´æ–°)
```

**UI çŠ¶æ€**:
- æ˜¾ç¤ºå€’è®¡æ—¶æ–‡æœ¬ (MM:SS)
- æ˜¾ç¤ºåœ†å½¢è¿›åº¦æ¡ (åˆå§‹è¿›åº¦ 0%)
- æ˜¾ç¤º "Pause" æŒ‰é’®
- éšè—æ—¶é•¿é€‰æ‹©å™¨

---

### é˜¶æ®µ 2: è¿è¡Œä¸­ - å€’è®¡æ—¶æ›´æ–°

```
å€’è®¡æ—¶å®šæ—¶å™¨ (æ¯ 50ms æ‰§è¡Œ)
    â†“
updateCountdown() [popup.js]
    â”œâ”€ æ£€æŸ¥ pomodoroState æ˜¯å¦å­˜åœ¨
    â”œâ”€ æ£€æŸ¥æ˜¯å¦æš‚åœ (status === 'PAUSED')
    â”‚  â””â”€ å¦‚æœæ˜¯æš‚åœï¼Œæ›´æ–°ä¸€æ¬¡è¿›åº¦ååœæ­¢å®šæ—¶å™¨
    â”œâ”€ è®¡ç®—å‰©ä½™æ—¶é—´: remaining = target_end_time - now
    â”œâ”€ æ£€æŸ¥æ˜¯å¦åˆ°æœŸ (remaining <= 0)
    â”‚  â””â”€ å¦‚æœåˆ°æœŸï¼Œè§¦å‘è‡ªåŠ¨åˆ‡æ¢ (è§é˜¶æ®µ 5)
    â”œâ”€ è®¡ç®—è¿›åº¦: progress = (elapsed / totalDuration)
    â”œâ”€ updateProgressBar(progress) [ui-manager.js]
    â”‚  â”œâ”€ æ›´æ–° SVG stroke-dashoffset
    â”‚  â”œâ”€ æ›´æ–°é€æ˜åº¦ (20% â†’ 100%)
    â”‚  â””â”€ æ›´æ–°é¢œè‰² (Focus: #FE8277, Break: #95D22B)
    â””â”€ updateCountdownText(timeString) [ui-manager.js]
       â””â”€ æ›´æ–°å€’è®¡æ—¶æ–‡æœ¬ (MM:SS)
```

**æ›´æ–°é¢‘ç‡**:
- **è¿›åº¦æ¡**: æ¯ 50ms æ›´æ–°ï¼ˆ20fpsï¼Œæµç•…åŠ¨ç”»ï¼‰
- **å€’è®¡æ—¶æ–‡æœ¬**: æ¯ç§’æ›´æ–°ï¼ˆé¿å…ä¸å¿…è¦çš„ DOM æ“ä½œï¼‰

**è§†è§‰æ•ˆæœ**:
- åœ†å½¢è¿›åº¦æ¡ä» 0% é€æ¸å¡«å……åˆ° 100%
- é€æ˜åº¦ä» 20% é€æ¸å¢åŠ åˆ° 100%
- é¢œè‰²æ ¹æ®ä¼šè¯ç±»å‹åŠ¨æ€å˜åŒ–

---

### é˜¶æ®µ 3: æš‚åœ - ç”¨æˆ·ç‚¹å‡» Pause

```
ç”¨æˆ·æ“ä½œ: ç‚¹å‡» "Pause" æŒ‰é’®
    â†“
1. handlePause() [event-handlers.js]
   â”œâ”€ ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€: status = 'PAUSED'
   â”œâ”€ clearIntervals() [popup.js]
   â”‚  â””â”€ æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
   â”œâ”€ showPausedState() [ui-manager.js]
   â”‚  â”œâ”€ æ˜¾ç¤º pausedActions (Continue + Stop æŒ‰é’®)
   â”‚  â””â”€ æ›´æ–°çŠ¶æ€æ ‡é¢˜: "Paused"
   â””â”€ å‘é€æ¶ˆæ¯åˆ° Background Script: action: 'pause_focus'
    â†“
2. Background Script å¤„ç† [background.js]
   â”œâ”€ æ›´æ–° Pomodoro State: status = 'PAUSED'
   â”œâ”€ ä¿å­˜çŠ¶æ€åˆ° Chrome Storage
   â””â”€ è¿”å›æ›´æ–°åçš„ pomodoroState
    â†“
3. Popup æ¥æ”¶å“åº”
   â”œâ”€ æ›´æ–°æœ¬åœ° pomodoroState
   â”œâ”€ renderPomodoroState() [ui-manager.js]
   â”‚  â””â”€ æ›´æ–° UI æ˜¾ç¤ºæš‚åœçŠ¶æ€
   â””â”€ syncPopupState() [popup.js]
      â””â”€ åŒæ­¥æ‰€æœ‰çŠ¶æ€æ•°æ®
```

**UI çŠ¶æ€**:
- å€’è®¡æ—¶æ–‡æœ¬ä¿æŒå½“å‰æ—¶é—´ï¼ˆä¸å†æ›´æ–°ï¼‰
- è¿›åº¦æ¡ä¿æŒå½“å‰è¿›åº¦ï¼ˆä¸å†åŠ¨ç”»ï¼‰
- æ˜¾ç¤º "Continue" å’Œ "Stop" æŒ‰é’®
- çŠ¶æ€æ ‡é¢˜æ˜¾ç¤º "Paused"

**å€’è®¡æ—¶å®šæ—¶å™¨è¡Œä¸º**:
- åœ¨ `updateCountdown()` ä¸­æ£€æµ‹åˆ° `status === 'PAUSED'`
- æ›´æ–°ä¸€æ¬¡è¿›åº¦æ¡åç«‹å³æ¸…é™¤å®šæ—¶å™¨
- ä¸å†æ›´æ–°å€’è®¡æ—¶æ–‡æœ¬

---

### é˜¶æ®µ 4: æ¢å¤ - ç”¨æˆ·ç‚¹å‡» Continue

```
ç”¨æˆ·æ“ä½œ: ç‚¹å‡» "Continue" æŒ‰é’®
    â†“
1. handleResume() [event-handlers.js]
   â””â”€ å‘é€æ¶ˆæ¯åˆ° Background Script: action: 'resume_focus'
    â†“
2. Background Script å¤„ç† [background.js]
   â”œâ”€ è®¡ç®—å‰©ä½™æ—¶é—´
   â”œâ”€ æ›´æ–° start_time = now - elapsed
   â”œâ”€ æ›´æ–° target_end_time = now + remaining
   â”œâ”€ æ›´æ–°çŠ¶æ€: status = 'RUNNING'
   â””â”€ è¿”å›æ›´æ–°åçš„ pomodoroState
    â†“
3. Popup æ¥æ”¶å“åº”
   â”œâ”€ æ›´æ–°æœ¬åœ° pomodoroState
   â”œâ”€ renderPomodoroState() [ui-manager.js]
   â”‚  â”œâ”€ æ›´æ–°çŠ¶æ€æ ‡é¢˜: "Focusing" / "Break"
   â”‚  â””â”€ æ˜¾ç¤ºå¯¹åº”çš„æ“ä½œæŒ‰é’®
   â”œâ”€ startCountdown() [popup.js]
   â”‚  â””â”€ é‡æ–°å¯åŠ¨å€’è®¡æ—¶å®šæ—¶å™¨
   â””â”€ startTimer() [popup.js]
      â””â”€ é‡æ–°å¯åŠ¨ç»Ÿè®¡å®šæ—¶å™¨
```

**å…³é”®ç‚¹**:
- Background Script é‡æ–°è®¡ç®—æ—¶é—´ï¼Œç¡®ä¿å€’è®¡æ—¶å‡†ç¡®
- å€’è®¡æ—¶ä»æš‚åœæ—¶çš„å‰©ä½™æ—¶é—´ç»§ç»­ï¼Œè€Œä¸æ˜¯é‡æ–°å¼€å§‹

---

### é˜¶æ®µ 5: è‡ªåŠ¨åˆ‡æ¢ - å€’è®¡æ—¶ç»“æŸ

```
å€’è®¡æ—¶å®šæ—¶å™¨æ£€æµ‹åˆ° remaining <= 0
    â†“
updateCountdown() [popup.js]
    â”œâ”€ æ›´æ–°å€’è®¡æ—¶æ–‡æœ¬: "00:00"
    â”œâ”€ æ›´æ–°è¿›åº¦æ¡: 100%
    â”œâ”€ æ¸…é™¤å€’è®¡æ—¶å®šæ—¶å™¨
    â””â”€ æ ¹æ® session_type å‘é€æ¶ˆæ¯:
       â”œâ”€ FOCUS â†’ action: 'end_focus'
       â””â”€ BREAK â†’ action: 'end_break'
    â†“
Background Script å¤„ç† [background.js]
    â”œâ”€ å¦‚æœæ˜¯ FOCUS ç»“æŸ:
    â”‚  â”œâ”€ ç´¯åŠ ä¸“æ³¨æ—¶é—´åˆ°ç»Ÿè®¡æ•°æ®
    â”‚  â”œâ”€ åˆ‡æ¢åˆ° BREAK ä¼šè¯
    â”‚  â”œâ”€ è®¡ç®— break æ—¶é•¿ (çŸ­ä¼‘æ¯ 5 åˆ†é’Ÿ / é•¿ä¼‘æ¯ 15 åˆ†é’Ÿ)
    â”‚  â”œâ”€ æ›´æ–° current_cycle
    â”‚  â””â”€ è®¾ç½®æ–°çš„ start_time å’Œ target_end_time
    â””â”€ å¦‚æœæ˜¯ BREAK ç»“æŸ:
       â”œâ”€ åˆ‡æ¢åˆ° FOCUS ä¼šè¯
       â”œâ”€ æ›´æ–° current_cycle
       â””â”€ è®¾ç½®æ–°çš„ start_time å’Œ target_end_time
    â†“
Popup æ¥æ”¶å“åº”
    â””â”€ syncPopupState() [popup.js]
       â”œâ”€ è·å–æœ€æ–°çš„ pomodoroState
       â”œâ”€ renderPomodoroState() [ui-manager.js]
       â”‚  â”œâ”€ æ›´æ–°çŠ¶æ€æ ‡é¢˜
       â”‚  â”œâ”€ æ›´æ–°æ“ä½œæŒ‰é’®
       â”‚  â””â”€ æ›´æ–°ç•ªèŒ„é’Ÿå‘¨æœŸæŒ‡ç¤ºå™¨
       â””â”€ startCountdown() [popup.js]
          â””â”€ å¯åŠ¨æ–°çš„å€’è®¡æ—¶
```

**è‡ªåŠ¨åˆ‡æ¢é€»è¾‘**:
- **Focus â†’ Break**: 
  - å¦‚æœ `current_cycle < 4`: çŸ­ä¼‘æ¯ (5 åˆ†é’Ÿ)
  - å¦‚æœ `current_cycle === 4`: é•¿ä¼‘æ¯ (15 åˆ†é’Ÿ)ï¼Œç„¶åé‡ç½®å‘¨æœŸ
- **Break â†’ Focus**: 
  - å¼€å§‹æ–°çš„ Focus ä¼šè¯ (25 åˆ†é’Ÿï¼Œæˆ–ç”¨æˆ·é€‰æ‹©çš„æ—¶é•¿)

---

### é˜¶æ®µ 6: åœæ­¢ - ç”¨æˆ·ç‚¹å‡» Stop

```
ç”¨æˆ·æ“ä½œ: ç‚¹å‡» "Stop" æŒ‰é’®
    â†“
1. handleStopFocus() [event-handlers.js]
   â”œâ”€ clearIntervals() [popup.js]
   â”‚  â””â”€ æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
   â””â”€ å‘é€æ¶ˆæ¯åˆ° Background Script: action: 'stop_focus'
    â†“
2. Background Script å¤„ç† [background.js]
   â”œâ”€ æ¸…é™¤ Pomodoro State
   â”œâ”€ æ¸…é™¤ Chrome Storage ä¸­çš„çŠ¶æ€
   â””â”€ è¿”å›æˆåŠŸå“åº”
    â†“
3. Popup æ¥æ”¶å“åº”
   â”œâ”€ é‡ç½®æœ¬åœ°å˜é‡: pomodoroState = null
   â”œâ”€ resetTimerState() [popup.js]
   â”œâ”€ updateCountdownDisplayFromDuration() [ui-manager.js]
   â”‚  â””â”€ æ˜¾ç¤ºé»˜è®¤æ—¶é•¿ (25:00 æˆ–ç”¨æˆ·é€‰æ‹©çš„æ—¶é•¿)
   â”œâ”€ updateProgressBar(0) [ui-manager.js]
   â”‚  â””â”€ é‡ç½®è¿›åº¦æ¡ä¸º 0%
   â”œâ”€ renderPomodoroState(null) [ui-manager.js]
   â”‚  â”œâ”€ æ˜¾ç¤ºæ—¶é•¿é€‰æ‹©å™¨
   â”‚  â”œâ”€ éšè—å€’è®¡æ—¶æ–‡æœ¬
   â”‚  â”œâ”€ æ˜¾ç¤º stoppedActions ("Start to Focus" æŒ‰é’®)
   â”‚  â””â”€ éšè—çŠ¶æ€æ ‡é¢˜
   â””â”€ æ›´æ–°ç•ªèŒ„é’Ÿå‘¨æœŸæŒ‡ç¤ºå™¨ä¸ºåˆå§‹çŠ¶æ€
```

**UI çŠ¶æ€**:
- æ˜¾ç¤ºæ—¶é•¿é€‰æ‹©å™¨ï¼ˆå¯ç‚¹å‡»ä¿®æ”¹æ—¶é•¿ï¼‰
- éšè—å€’è®¡æ—¶æ–‡æœ¬
- æ˜¾ç¤º "Start to Focus" æŒ‰é’®
- è¿›åº¦æ¡é‡ç½®ä¸º 0%
- ç•ªèŒ„é’Ÿå‘¨æœŸæŒ‡ç¤ºå™¨é‡ç½®

---

### é˜¶æ®µ 7: æ—¶é•¿é€‰æ‹© - åœæ­¢çŠ¶æ€ä¸‹ä¿®æ”¹æ—¶é•¿

#### é»˜è®¤çŠ¶æ€ï¼ˆåœæ­¢æ—¶ï¼‰
```
renderPomodoroState(null) [ui-manager.js]
    â”œâ”€ toggleDurationPicker(false) - éšè—æ»šè½®
    â”œâ”€ updateCountdownDisplayFromDuration() - æ˜¾ç¤ºå½“å‰æ—¶é—´ (MM:00)
    â””â”€ æ·»åŠ  'clickable' class - æ—¶é—´æ–‡æœ¬å¯ç‚¹å‡»ï¼ˆé¼ æ ‡æ‚¬åœæ—¶å˜é€æ˜ï¼‰
```

**UI çŠ¶æ€**:
- âœ… æ˜¾ç¤ºæ—¶é—´æ–‡æœ¬ï¼ˆå¦‚ "25:00"ï¼‰
- âŒ ä¸æ˜¾ç¤ºæ»šè½®
- âœ… æ—¶é—´æ–‡æœ¬å¯ç‚¹å‡»ï¼ˆé¼ æ ‡æŒ‡é’ˆå˜ä¸ºæ‰‹å‹ï¼Œæ‚¬åœæ—¶å˜é€æ˜ï¼‰

#### ç”¨æˆ·ç‚¹å‡»æ—¶é—´æ–‡æœ¬
```
ç”¨æˆ·æ“ä½œ: ç‚¹å‡»æ—¶é—´æ–‡æœ¬ï¼ˆåœæ­¢çŠ¶æ€ä¸‹ï¼‰
    â†“
countdownDisplay click handler [popup.js]
    â”œâ”€ æ£€æŸ¥æ˜¯å¦åœæ­¢çŠ¶æ€
    â”œâ”€ æ£€æŸ¥æ»šè½®æ˜¯å¦å·²æ˜¾ç¤º
    â””â”€ toggleDurationPicker(!isPickerVisible)
       â”œâ”€ å¦‚æœæ»šè½®éšè— â†’ æ˜¾ç¤ºæ»šè½®ï¼Œéšè—æ—¶é—´æ–‡æœ¬
       â””â”€ å¦‚æœæ»šè½®æ˜¾ç¤º â†’ éšè—æ»šè½®ï¼Œæ˜¾ç¤ºæ—¶é—´æ–‡æœ¬
```

**UI çŠ¶æ€åˆ‡æ¢**:
- ç‚¹å‡»å‰ï¼šæ˜¾ç¤ºæ—¶é—´æ–‡æœ¬ï¼Œéšè—æ»šè½®
- ç‚¹å‡»åï¼šéšè—æ—¶é—´æ–‡æœ¬ï¼Œæ˜¾ç¤ºæ»šè½®

#### ç”¨æˆ·é€‰æ‹©æ—¶é•¿
```
ç”¨æˆ·æ“ä½œ: æ»šåŠ¨æˆ–ç‚¹å‡»é€‰æ‹©æ—¶é•¿ (5/15/25/30/45 åˆ†é’Ÿ)
    â†“
initializeDurationPicker() [ui-manager.js]
    â”œâ”€ æ–¹å¼1: æ»šåŠ¨é€‰æ‹©
    â”‚  â”œâ”€ æ£€æµ‹é€‰ä¸­çš„æ—¶é•¿ï¼ˆæ»šåŠ¨åœæ­¢å 150msï¼‰
    â”‚  â”œâ”€ ä¿å­˜åˆ° Chrome Storage: focusDuration
    â”‚  â”œâ”€ æ›´æ–°å€’è®¡æ—¶æ–‡æœ¬æ˜¾ç¤º
    â”‚  â””â”€ toggleDurationPicker(false) - éšè—æ»šè½®ï¼Œæ˜¾ç¤ºæ—¶é—´æ–‡æœ¬
    â””â”€ æ–¹å¼2: ç‚¹å‡»é€‰é¡¹
       â”œâ”€ æ»šåŠ¨åˆ°é€‰ä¸­é¡¹
       â”œâ”€ ä¿å­˜åˆ° Chrome Storage: focusDuration
       â”œâ”€ æ›´æ–°å€’è®¡æ—¶æ–‡æœ¬æ˜¾ç¤º
       â””â”€ toggleDurationPicker(false) - éšè—æ»šè½®ï¼Œæ˜¾ç¤ºæ—¶é—´æ–‡æœ¬
```

**äº¤äº’ç»†èŠ‚**:
- âœ… åªæœ‰åœæ­¢çŠ¶æ€ (`status === 'IDLE'` æˆ– `pomodoroState === null`) æ‰èƒ½ä¿®æ”¹æ—¶é•¿
- âœ… æ»šåŠ¨é€‰æ‹©å™¨æ—¶ï¼Œé€‰é¡¹é¢œè‰²ä¼šæ ¹æ®è·ç¦»ä¸­å¿ƒçš„ä½ç½®æ¸å˜
- âœ… é€‰æ‹©åè‡ªåŠ¨ä¿å­˜åˆ° Chrome Storageï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶ä½¿ç”¨
- âœ… **é€‰æ‹©åè‡ªåŠ¨éšè—æ»šè½®ï¼Œæ˜¾ç¤ºé€‰æ‹©çš„æ—¶é—´æ–‡æœ¬**
- âœ… **å†æ¬¡ç‚¹å‡»æ—¶é—´æ–‡æœ¬å¯é‡æ–°æ˜¾ç¤ºæ»šè½®è¿›è¡Œä¿®æ”¹**

#### å®Œæ•´äº¤äº’æµç¨‹
```
[åœæ­¢çŠ¶æ€]
   â†“
[æ˜¾ç¤ºæ—¶é—´æ–‡æœ¬] (é»˜è®¤ï¼Œä¸æ˜¾ç¤ºæ»šè½®)
   â†“
[ç”¨æˆ·ç‚¹å‡»æ—¶é—´æ–‡æœ¬]
   â†“
[æ˜¾ç¤ºæ»šè½®] (éšè—æ—¶é—´æ–‡æœ¬)
   â†“
[ç”¨æˆ·æ»šåŠ¨/ç‚¹å‡»é€‰æ‹©æ—¶é•¿]
   â†“
[éšè—æ»šè½®ï¼Œæ˜¾ç¤ºé€‰æ‹©çš„æ—¶é—´] (è‡ªåŠ¨)
   â†“
[ç”¨æˆ·å†æ¬¡ç‚¹å‡»æ—¶é—´æ–‡æœ¬] (å¯é€‰)
   â†“
[é‡æ–°æ˜¾ç¤ºæ»šè½®] (å¾ªç¯)
```

---

## ğŸ¨ UI æ›´æ–°æµç¨‹

### å€’è®¡æ—¶æ–‡æœ¬æ›´æ–°
```javascript
// æ¯ 50ms è®¡ç®—ï¼Œä½†åªåœ¨ç§’æ•°å˜åŒ–æ—¶æ›´æ–° DOM
const timeString = formatCountdownTime(remaining); // "MM:SS"
updateCountdownText(timeString); // åªåœ¨å†…å®¹å˜åŒ–æ—¶æ›´æ–°
```

### è¿›åº¦æ¡æ›´æ–°
```javascript
// æ¯ 50ms æ›´æ–°
const progress = calculateProgress(start_time, end_time); // 0-1
updateProgressBar(progress, pomodoroState);
  â”œâ”€ æ›´æ–° stroke-dashoffset (SVG è·¯å¾„)
  â”œâ”€ æ›´æ–°é€æ˜åº¦ (20% â†’ 100%)
  â””â”€ æ›´æ–°é¢œè‰² (æ ¹æ® session_type)
```

### çŠ¶æ€åˆ‡æ¢
```javascript
renderPomodoroState(pomodoroState);
  â”œâ”€ æ›´æ–°çŠ¶æ€æ ‡é¢˜ ("Focusing" / "Break" / "Paused")
  â”œâ”€ æ›´æ–°æ“ä½œæŒ‰é’® (æ˜¾ç¤º/éšè—å¯¹åº”çš„æŒ‰é’®ç»„)
  â”œâ”€ æ›´æ–°ç•ªèŒ„é’Ÿå‘¨æœŸæŒ‡ç¤ºå™¨
  â””â”€ åˆ‡æ¢æ—¶é•¿é€‰æ‹©å™¨/å€’è®¡æ—¶æ–‡æœ¬æ˜¾ç¤º
```

---

## ğŸ”— æ¨¡å—é—´é€šä¿¡

### Popup â†” Background Script

**æ¶ˆæ¯ç±»å‹**:
- `init_focus`: åˆå§‹åŒ– Focus ä¼šè¯
- `pause_focus`: æš‚åœå½“å‰ä¼šè¯
- `resume_focus`: æ¢å¤å½“å‰ä¼šè¯
- `stop_focus`: åœæ­¢å¹¶æ¸…é™¤çŠ¶æ€
- `end_focus`: Focus ä¼šè¯ç»“æŸï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰
- `end_break`: Break ä¼šè¯ç»“æŸï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰
- `getPopupState`: è·å–å½“å‰å®Œæ•´çŠ¶æ€

**æ•°æ®æµ**:
```
Popup â†’ Background Script: å‘é€æ“ä½œè¯·æ±‚
Background Script â†’ Popup: è¿”å›æ›´æ–°åçš„ pomodoroState
Popup: æ›´æ–°æœ¬åœ°çŠ¶æ€å’Œ UI
```

---

## ğŸ“Š çŠ¶æ€æŒä¹…åŒ–

### Chrome Storage
- **focusDuration**: ç”¨æˆ·é€‰æ‹©çš„ä¸“æ³¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
- **focusKeywords**: ä¸“æ³¨å…³é”®è¯
- **timerState**: 'running' | 'paused' | 'stopped'
- **elapsedTime**: å·²ç´¯è®¡çš„ä¸“æ³¨æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

### Pomodoro State (Background Script)
- å­˜å‚¨åœ¨ Background Script çš„å†…å­˜ä¸­
- é€šè¿‡ `getPopupState` æ¶ˆæ¯è·å–æœ€æ–°çŠ¶æ€
- å…³é—­ Popup åé‡æ–°æ‰“å¼€æ—¶ï¼Œé€šè¿‡ `syncPopupState()` åŒæ­¥

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. æ›´æ–°é¢‘ç‡ä¼˜åŒ–
- **è¿›åº¦æ¡**: 50ms (20fps) - ç¡®ä¿åŠ¨ç”»æµç•…
- **å€’è®¡æ—¶æ–‡æœ¬**: åªåœ¨ç§’æ•°å˜åŒ–æ—¶æ›´æ–° - å‡å°‘ DOM æ“ä½œ
- **ç»Ÿè®¡æ›´æ–°**: æ¯ 10 ç§’æ›´æ–°ä¸€æ¬¡ - å‡å°‘ API è°ƒç”¨

### 2. æ¡ä»¶æ›´æ–°
```javascript
// åªåœ¨å†…å®¹å˜åŒ–æ—¶æ›´æ–° DOM
if (countdownText && countdownText.textContent !== timeString) {
  countdownText.textContent = timeString;
}
```

### 3. å®šæ—¶å™¨ç®¡ç†
- æš‚åœæ—¶ç«‹å³æ¸…é™¤å®šæ—¶å™¨
- åœæ­¢æ—¶æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
- é¿å…å†…å­˜æ³„æ¼

---

## ğŸ› è¾¹ç•Œæƒ…å†µå¤„ç†

### 1. Popup å…³é—­åé‡æ–°æ‰“å¼€
- é€šè¿‡ `syncPopupState()` ä» Background Script è·å–æœ€æ–°çŠ¶æ€
- æ¢å¤å€’è®¡æ—¶å®šæ—¶å™¨
- æ›´æ–° UI æ˜¾ç¤º

### 2. æ—¶é—´åŒæ­¥é—®é¢˜
- ä½¿ç”¨ `Date.now()` è·å–å½“å‰æ—¶é—´æˆ³
- Background Script åœ¨æ¢å¤æ—¶é‡æ–°è®¡ç®—æ—¶é—´
- ç¡®ä¿å€’è®¡æ—¶å‡†ç¡®æ€§

### 3. çŠ¶æ€ä¸ä¸€è‡´
- æ¯æ¬¡æ“ä½œåè°ƒç”¨ `syncPopupState()` åŒæ­¥çŠ¶æ€
- Background Script ä½œä¸ºå•ä¸€æ•°æ®æº
- Popup æœ¬åœ°çŠ¶æ€ä»…ç”¨äº UI æ›´æ–°

---

## ğŸ“ å…³é”®ä»£ç ä½ç½®

### Popup æ¨¡å—
- **å€’è®¡æ—¶é€»è¾‘**: `popup.js:248-334` (`startCountdown()`)
- **äº‹ä»¶å¤„ç†**: `event-handlers.js` (æ‰€æœ‰ç”¨æˆ·æ“ä½œ)
- **UI æ›´æ–°**: `ui-manager.js` (DOM æ“ä½œå’ŒçŠ¶æ€åˆ‡æ¢)
- **æ—¶é—´å·¥å…·**: `time-utils.js` (æ—¶é—´æ ¼å¼åŒ–å’Œè®¡ç®—)

### Background Script
- **çŠ¶æ€ç®¡ç†**: `background.js` (Pomodoro State ç®¡ç†)
- **æ¶ˆæ¯å¤„ç†**: `background.js:352+` (å¤„ç†æ‰€æœ‰æ“ä½œè¯·æ±‚)

---

## ğŸ”„ å®Œæ•´æµç¨‹å›¾

```
[åˆå§‹åŒ–]
   â†“
[è¿è¡Œä¸­] â†â†’ [æš‚åœ] â†â†’ [æ¢å¤]
   â†“
[è‡ªåŠ¨åˆ‡æ¢] (Focus â†” Break)
   â†“
[åœæ­¢] â†’ [æ—¶é•¿é€‰æ‹©] â†’ [é‡æ–°å¼€å§‹]
```

---

*æœ¬æ–‡æ¡£ä¼šéšç€åŠŸèƒ½æ›´æ–°æŒç»­ç»´æŠ¤*

